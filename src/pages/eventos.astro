---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

const eventos = await getCollection("events");
const hoje = new Date();
hoje.setHours(0, 0, 0, 0);

const ordenados = [...eventos].sort((a, b) => {
  const dataA = new Date(a.data.data);
  const dataB = new Date(b.data.data);
  const futuroA = dataA >= hoje;
  const futuroB = dataB >= hoje;

  if (futuroA && !futuroB) return -1;
  if (!futuroA && futuroB) return 1;

  if (futuroA && futuroB) return dataA.getTime() - dataB.getTime();
  return dataB.getTime() - dataA.getTime();
});

const formatarData = (data) =>
  new Intl.DateTimeFormat("pt-BR", {
    day: "2-digit",
    month: "long",
    year: "numeric",
  }).format(data);
---

<BaseLayout title="Eventos | LAPAN" description="Agenda de eventos do laboratório com próximos eventos em destaque.">
  <section>
    <p class="text-xs font-semibold uppercase tracking-[0.14em] text-accent-700">Agenda</p>
    <h1 class="mt-3 text-4xl text-brand-900 sm:text-5xl">Eventos</h1>
    <p class="mt-4 max-w-3xl text-base leading-relaxed text-neutral-700">
      Esta página é atualizada pelo Decap CMS. Eventos futuros aparecem primeiro.
    </p>
  </section>

  {ordenados.length === 0 ? (
    <section class="mt-8 rounded-2xl border border-brand-200 bg-surface p-6">
      <p class="text-neutral-700">Nenhum evento cadastrado no momento.</p>
    </section>
  ) : (
    <section class="pt-10 space-y-4">
      {ordenados.map((evento) => {
        const dataEvento = new Date(evento.data.data);
        const ehFuturo = dataEvento >= hoje;

        return (
          <article class="rounded-2xl border border-brand-200 bg-surface p-5 shadow-soft">
            <div class="flex flex-wrap items-center gap-2">
              <p class="text-sm font-semibold text-brand-700">{formatarData(dataEvento)}</p>
              <span class={`rounded-full px-2.5 py-1 text-xs font-semibold ${ehFuturo ? "bg-accent-100 text-accent-700" : "bg-brand-100 text-brand-700"}`}>
                {ehFuturo ? "Próximo" : "Realizado"}
              </span>
            </div>

            <h2 class="mt-2 text-2xl text-brand-900">{evento.data.titulo}</h2>
            <p class="mt-1 text-sm font-semibold text-neutral-700">{evento.data.local}</p>

            {evento.data.imagem && (
              <img
                src={evento.data.imagem}
                alt={`Imagem do evento ${evento.data.titulo}`}
                class="mt-4 h-52 w-full rounded-xl object-cover"
                loading="lazy"
                decoding="async"
              />
            )}

            <p class="mt-4 text-sm leading-relaxed text-neutral-700">{evento.data.descricao}</p>

            {evento.data.link && (
              <a
                href={evento.data.link}
                target="_blank"
                rel="noreferrer"
                class="mt-4 inline-flex rounded-md bg-accent-500 px-4 py-2 text-sm font-semibold text-surface transition hover:bg-accent-600"
              >
                Acessar link do evento
              </a>
            )}
          </article>
        );
      })}
    </section>
  )}
</BaseLayout>
