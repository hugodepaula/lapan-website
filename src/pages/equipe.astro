---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

const ordemTipos = ["Pesquisador", "Doutorado", "Mestrado", "Iniciação Científica", "Colaborador"];
const membros = await getCollection("team");
const prioridadePesquisadores: Record<string, number> = {
  "Prof. Dr. Marcos Pinotti Barbosa (In Memoriam)": 0,
  "Prof. Dr. Ricardo Queiroz Guimarães": 1,
};

const membrosOrdenados = [...membros].sort((a, b) => {
  const tipoA = ordemTipos.indexOf(a.data.tipo);
  const tipoB = ordemTipos.indexOf(b.data.tipo);
  if (tipoA !== tipoB) return tipoA - tipoB;
  if (a.data.tipo === "Pesquisador" && b.data.tipo === "Pesquisador") {
    const prioridadeA = prioridadePesquisadores[a.data.nome] ?? Number.MAX_SAFE_INTEGER;
    const prioridadeB = prioridadePesquisadores[b.data.nome] ?? Number.MAX_SAFE_INTEGER;
    if (prioridadeA !== prioridadeB) return prioridadeA - prioridadeB;
  }
  return a.data.nome.localeCompare(b.data.nome, "pt-BR");
});

const grupos = ordemTipos
  .map((tipo) => ({ tipo, itens: membrosOrdenados.filter((item) => item.data.tipo === tipo) }))
  .filter((grupo) => grupo.itens.length > 0);

const tipoParaFiltro = (tipo: string) =>
  tipo
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .replace(/\s+/g, "-");
---

<BaseLayout title="Equipe | LAPAN" description="Equipe do laboratório organizada por nível e função acadêmica.">
  <section>
    <p class="text-xs font-semibold uppercase tracking-[0.14em] text-accent-700">Pessoas</p>
    <h1 class="mt-3 text-4xl text-brand-900 sm:text-5xl">Equipe</h1>
  </section>

  {grupos.length === 0 ? (
    <section class="mt-8 rounded-2xl border border-brand-200 bg-surface p-6">
      <p class="text-neutral-700">Nenhum membro cadastrado no momento.</p>
    </section>
  ) : (
    <>
      <section class="mt-8 rounded-2xl border border-brand-200 bg-surface p-4 sm:p-5" aria-label="Filtrar equipe por tipo">
        <p class="text-sm font-semibold text-brand-900">Filtrar por tipo</p>
        <div class="mt-3 flex flex-wrap gap-2">
          <button
            type="button"
            data-filter="todos"
            aria-pressed="true"
            class="team-filter-btn cursor-pointer rounded-full border border-brand-300 bg-brand-900 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-brand-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent-600"
          >
            Todos
          </button>
          {grupos.map((grupo) => (
            <button
              type="button"
              data-filter={tipoParaFiltro(grupo.tipo)}
              aria-pressed="false"
              class="team-filter-btn cursor-pointer rounded-full border border-brand-300 bg-surface px-3 py-1.5 text-xs font-semibold text-brand-800 transition hover:border-brand-500 hover:bg-brand-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent-600"
            >
              {grupo.tipo}
            </button>
          ))}
        </div>
      </section>

      {grupos.map((grupo) => (
      <section class="pt-12" data-team-group data-filter-key={tipoParaFiltro(grupo.tipo)}>
        <h2 class="text-2xl text-brand-900">{grupo.tipo}</h2>
        <div class="mt-5 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {grupo.itens.map((membro) => (
            <article class="rounded-2xl border border-brand-200 bg-surface p-5 shadow-soft">
              <img
                src={membro.data.foto || "/images/logo_squared.png"}
                alt={`Foto de ${membro.data.nome}`}
                class="aspect-[4/5] w-full rounded-xl border border-brand-200 bg-brand-50 p-2 object-contain"
                loading="lazy"
                decoding="async"
              />
              <h3 class="mt-4 text-xl text-brand-900">{membro.data.nome}</h3>
              <p class="text-sm font-semibold text-accent-700">{membro.data.cargo}</p>
              <p class="mt-2 text-sm leading-relaxed text-neutral-700">{membro.data.bio}</p>

              {membro.data.links.length > 0 && (
                <ul class="mt-4 flex flex-wrap gap-2">
                  {membro.data.links.map((link) => (
                    <li>
                      <a
                        href={link.url}
                        target="_blank"
                        rel="noreferrer"
                        class="inline-flex rounded-md border border-brand-200 px-2.5 py-1 text-xs font-semibold text-brand-700 transition hover:border-brand-400 hover:bg-brand-50"
                      >
                        {link.rotulo}
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </article>
          ))}
        </div>
      </section>
      ))}
    </>
  )}
</BaseLayout>

<script>
  const botoes = Array.from(document.querySelectorAll(".team-filter-btn"));
  const grupos = Array.from(document.querySelectorAll("[data-team-group]"));

  const aplicarFiltro = (filtro: string) => {
    grupos.forEach((grupo) => {
      const chave = grupo.dataset.filterKey;
      const exibir = filtro === "todos" || chave === filtro;
      grupo.classList.toggle("hidden", !exibir);
    });

    botoes.forEach((botao) => {
      const ativo = botao.dataset.filter === filtro;
      botao.setAttribute("aria-pressed", String(ativo));
      botao.classList.toggle("bg-brand-900", ativo);
      botao.classList.toggle("text-white", ativo);
      botao.classList.toggle("bg-surface", !ativo);
      botao.classList.toggle("text-brand-800", !ativo);
    });
  };

  botoes.forEach((botao) => {
    botao.addEventListener("click", () => {
      aplicarFiltro(botao.dataset.filter || "todos");
    });
  });
</script>
