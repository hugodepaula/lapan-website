---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

const eventos = await getCollection("events");
const hoje = new Date();
hoje.setHours(0, 0, 0, 0);

const ordenados = [...eventos].sort((a, b) => {
  const dataA = new Date(a.data.data);
  const dataB = new Date(b.data.data);
  const futuroA = dataA >= hoje;
  const futuroB = dataB >= hoje;

  if (futuroA && !futuroB) return -1;
  if (!futuroA && futuroB) return 1;

  if (futuroA && futuroB) return dataA.getTime() - dataB.getTime();
  return dataB.getTime() - dataA.getTime();
});

const anosDisponiveis = [...new Set(ordenados.map((evento) => new Date(evento.data.data).getFullYear()))].sort((a, b) => b - a);

const formatarData = (data) =>
  new Intl.DateTimeFormat("pt-BR", {
    day: "2-digit",
    month: "long",
    year: "numeric",
  }).format(data);

const semCropImages = new Set([
  "/images/migration/eventos/cbnv-6.png",
  "/images/migration/eventos/cbnv-7.png",
]);

const semCropLandscape862x307 = new Set([
  "/images/migration/eventos/cbnv-1.png",
  "/images/migration/eventos/cbnv-2.png",
  "/images/migration/eventos/cbnv-3.png",
  "/images/migration/eventos/cbnv-8.png",
  "/images/migration/eventos/cbnv-9.png",
  "/images/migration/eventos/cbnv-11.png",
  "/images/migration/eventos/cbnv-12.png",
  "/images/migration/eventos/curso-darv.png",
  "/images/migration/eventos/reuniao-cientifica-abril.png",
]);
---

<BaseLayout title="Eventos | LAPAN" description="Agenda de eventos do laboratório com próximos eventos em destaque.">
  <section>
    <p class="text-xs font-semibold uppercase tracking-[0.14em] text-accent-700">Agenda</p>
    <h1 class="mt-3 text-4xl text-brand-900 sm:text-5xl">Eventos</h1>
  </section>

  {ordenados.length === 0 ? (
    <section class="mt-8 rounded-2xl border border-brand-200 bg-surface p-6">
      <p class="text-neutral-700">Nenhum evento cadastrado no momento.</p>
    </section>
  ) : (
    <section class="pt-10 space-y-4">
      <div class="flex items-center gap-3">
        <label for="filtro-ano-evento" class="text-sm font-semibold text-neutral-700">Filtrar por ano:</label>
        <select
          id="filtro-ano-evento"
          class="rounded-md border border-brand-200 bg-surface px-3 py-2 text-sm text-neutral-800 shadow-soft focus:border-accent-500 focus:outline-none"
        >
          <option value="todos">Todos</option>
          {anosDisponiveis.map((ano) => (
            <option value={String(ano)}>{ano}</option>
          ))}
        </select>
      </div>

      {ordenados.map((evento) => {
        const dataEvento = new Date(evento.data.data);
        const ehFuturo = dataEvento >= hoje;
        const anoEvento = dataEvento.getFullYear();

        return (
          <article class="evento-item rounded-2xl border border-brand-200 bg-surface p-5 shadow-soft" data-ano={String(anoEvento)}>
            <div class="flex flex-wrap items-center gap-2">
              <p class="text-sm font-semibold text-brand-700">{formatarData(dataEvento)}</p>
              <span class={`rounded-full px-2.5 py-1 text-xs font-semibold ${ehFuturo ? "bg-accent-100 text-accent-700" : "bg-brand-100 text-brand-700"}`}>
                {ehFuturo ? "Próximo" : "Realizado"}
              </span>
            </div>

            <h2 class="mt-2 text-2xl text-brand-900">{evento.data.titulo}</h2>
            <p class="mt-1 text-sm font-semibold text-neutral-700">{evento.data.local}</p>

            {evento.data.imagem && (
              <img
                src={evento.data.imagem}
                alt={`Imagem do evento ${evento.data.titulo}`}
                class={["mt-4 w-full rounded-xl", semCropLandscape862x307.has(evento.data.imagem) ? "h-auto object-contain" : semCropImages.has(evento.data.imagem) ? "h-52 object-contain bg-neutral-100" : "h-52 object-cover"].join(" ")}
                loading="lazy"
                decoding="async"
              />
            )}

            <p class="mt-4 text-sm leading-relaxed text-neutral-700">{evento.data.descricao}</p>

            {evento.data.link && (
              <a
                href={evento.data.link}
                target="_blank"
                rel="noreferrer"
                class="mt-4 inline-flex rounded-md bg-accent-500 px-4 py-2 text-sm font-semibold text-surface transition hover:bg-accent-600"
              >
                Acessar link do evento
              </a>
            )}
          </article>
        );
      })}
      <p id="eventos-sem-resultado" class="hidden rounded-2xl border border-brand-200 bg-surface p-6 text-neutral-700">
        Nenhum evento encontrado para o ano selecionado.
      </p>
    </section>
  )}

  <script>
    const filtroAno = document.querySelector("#filtro-ano-evento");
    const eventos = document.querySelectorAll(".evento-item");
    const semResultado = document.querySelector("#eventos-sem-resultado");

    if (filtroAno && eventos.length > 0 && semResultado) {
      const aplicarFiltro = () => {
        const anoSelecionado = filtroAno.value;
        let visiveis = 0;

        eventos.forEach((evento) => {
          const deveMostrar = anoSelecionado === "todos" || evento.dataset.ano === anoSelecionado;
          evento.classList.toggle("hidden", !deveMostrar);
          if (deveMostrar) visiveis += 1;
        });

        semResultado.classList.toggle("hidden", visiveis > 0);
      };

      filtroAno.addEventListener("change", aplicarFiltro);
      aplicarFiltro();
    }
  </script>
</BaseLayout>
